name: üìä Extracci√≥n Diaria de Datos - RevOps ARE

on:
  schedule:
    # Ejecuta a las 07:00 AM Chile (11:00 UTC en verano, 10:00 UTC en invierno)
    # Durante horario de verano chileno (Oct-Mar): 11:00 UTC = 07:00 CLT
    - cron: '0 11 * * *'

  # Permite ejecuci√≥n manual desde GitHub Actions UI
  workflow_dispatch:
    inputs:
      days_back:
        description: 'D√≠as hacia atr√°s a procesar (default: 1)'
        required: false
        default: '1'

env:
  PYTHON_VERSION: '3.10'
  TIMEZONE: 'America/Santiago'

jobs:
  extract-and-update:
    name: üîÑ Extraer datos y actualizar dashboard
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # 1. SETUP - C√≥digo y Entorno
      # ========================================
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historial completo para mejor debugging

      - name: üêç Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # Cache de dependencias para velocidad

      - name: üì¶ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ========================================
      # 2. CONFIGURACI√ìN - Archivos temporales
      # ========================================
      - name: ‚öôÔ∏è Crear configuraci√≥n temporal con credenciales
        env:
          HUBSPOT_API_KEY: ${{ secrets.HUBSPOT_API_KEY }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        run: |
          # Crear config.yaml temporal con API keys desde secrets
          cat > config/config.yaml << 'EOFCONFIG'
          # Configuraci√≥n del proyecto RevOps Dashboard - ARE
          # ‚ö†Ô∏è GENERADO AUTOM√ÅTICAMENTE - NO EDITAR MANUALMENTE

          hubspot:
            api_key: "${{ secrets.HUBSPOT_API_KEY }}"
            account_id: "50226191"

          google_sheets:
            informe_diario_id: "1E15l2Ac6EJsMEWS5SaOJnQHkNs6VQISBF1XfZ4NfrK4"
            archivo_looker_id: "1Xsj3BFUand7o1XXiZf-1HI77iu6ysd6rstQXX1tFpME"
            worksheet_name: "ACT comercial"
            editor_email: "dixolivos@gmail.com"

          google_calendar:
            calendar_id: "tomas@advisorrealestate.cl"
            ical_url: "https://calendar.google.com/calendar/ical/tomas%40advisorrealestate.cl/public/basic.ics"
            color_mapping:
              "8": "Teresa"
              "2": "Daniela"
              "9": "Azul"
            no_show_colors:
              - "6"
              - "11"
            robot_title_pattern: "Asesor√≠a Inmobiliaria"
            human_title_pattern: "Reunion"

          extraction:
            timezone: "America/Santiago"
            days_back: ${{ github.event.inputs.days_back || 1 }}

          alerts:
            cpl_max: 6000
            show_up_rate_min: 0.60
            conversion_rate_min: 0.10

          dashboard:
            port: 8080
            auto_refresh_seconds: 300
          EOFCONFIG

          # Crear credenciales de Google Service Account
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT }}' > config/google_credentials.json

          # Verificar que los archivos se crearon
          echo "‚úÖ Archivos de configuraci√≥n creados:"
          ls -lh config/

      # ========================================
      # 3. VALIDACI√ìN - Verificar setup
      # ========================================
      - name: üîç Verificar configuraci√≥n y credenciales
        run: |
          echo "üîç Verificando setup..."

          # Verificar que config.yaml existe y tiene contenido
          if [ ! -f "config/config.yaml" ]; then
            echo "‚ùå ERROR: config.yaml no existe"
            exit 1
          fi

          # Verificar que Google credentials existe
          if [ ! -f "config/google_credentials.json" ]; then
            echo "‚ùå ERROR: google_credentials.json no existe"
            exit 1
          fi

          # Verificar que HubSpot API key no est√° vac√≠a
          if ! grep -q "api_key:" config/config.yaml; then
            echo "‚ùå ERROR: HubSpot API key no configurada"
            exit 1
          fi

          echo "‚úÖ Configuraci√≥n verificada correctamente"

          # Ejecutar script de verificaci√≥n si existe
          if [ -f "scripts/verify_setup.py" ]; then
            python scripts/verify_setup.py || true
          fi

      # ========================================
      # 4. EXTRACCI√ìN - Ejecutar scripts
      # ========================================
      - name: üóìÔ∏è Extraer datos de Google Calendar
        id: calendar
        run: |
          echo "üóìÔ∏è Extrayendo reuniones de Google Calendar..."
          python scripts/calendar_extractor.py 2>&1 | tee logs/calendar_extraction.log

          # Capturar exit code
          CALENDAR_EXIT=$?
          echo "calendar_exit_code=$CALENDAR_EXIT" >> $GITHUB_OUTPUT

          if [ $CALENDAR_EXIT -ne 0 ]; then
            echo "‚ö†Ô∏è Extracci√≥n de Calendar fall√≥ con c√≥digo $CALENDAR_EXIT"
          else
            echo "‚úÖ Extracci√≥n de Calendar completada"
          fi

      - name: üìä Extraer datos de HubSpot
        id: hubspot
        run: |
          echo "üìä Extrayendo datos de HubSpot..."
          python scripts/main_extractor.py 2>&1 | tee logs/main_extraction.log

          # Capturar exit code
          HUBSPOT_EXIT=$?
          echo "hubspot_exit_code=$HUBSPOT_EXIT" >> $GITHUB_OUTPUT

          if [ $HUBSPOT_EXIT -ne 0 ]; then
            echo "‚ùå Extracci√≥n de HubSpot fall√≥ con c√≥digo $HUBSPOT_EXIT"
            exit 1
          else
            echo "‚úÖ Extracci√≥n de HubSpot completada"
          fi

      # ========================================
      # 5. PROCESAMIENTO - Datos y archivos
      # ========================================
      - name: üíæ Guardar datos extra√≠dos
        run: |
          echo "üíæ Procesando datos extra√≠dos..."

          # Buscar el archivo de extracci√≥n m√°s reciente
          LATEST_FILE=$(ls -t data/extracted_*.json 2>/dev/null | head -1 || echo "")

          if [ -z "$LATEST_FILE" ]; then
            echo "‚ùå ERROR: No se encontr√≥ archivo de extracci√≥n"
            exit 1
          fi

          echo "üìÑ Archivo encontrado: $LATEST_FILE"

          # Copiar a latest.json para el dashboard
          cp "$LATEST_FILE" data/latest.json

          # Mostrar preview de los datos
          echo "üìä Preview de los datos:"
          cat data/latest.json | python -m json.tool | head -30

          echo "‚úÖ Datos guardados correctamente"

      - name: üìù Actualizar Google Sheet
        if: success()
        run: |
          echo "üìù Actualizando Google Sheet..."

          if [ -f "scripts/sheet_updater.py" ]; then
            python scripts/sheet_updater.py 2>&1 | tee logs/sheet_update.log

            SHEET_EXIT=$?
            if [ $SHEET_EXIT -ne 0 ]; then
              echo "‚ö†Ô∏è Actualizaci√≥n de Sheet fall√≥ (no cr√≠tico)"
            else
              echo "‚úÖ Google Sheet actualizado correctamente"
            fi
          else
            echo "‚ö†Ô∏è Script sheet_updater.py no encontrado (saltando)"
          fi

      # ========================================
      # 6. COMMIT - Guardar resultados
      # ========================================
      - name: üîê Configurar Git
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions Bot"

      - name: üíæ Commit y push de datos
        run: |
          # Agregar solo los archivos de datos (NO config con credenciales)
          git add data/*.json

          # Agregar logs si existen
          git add logs/*.log 2>/dev/null || true

          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No hay cambios para commitear"
          else
            # Crear commit con fecha
            COMMIT_DATE=$(date +'%Y-%m-%d %H:%M %Z')
            git commit -m "üìä Datos extra√≠dos - $COMMIT_DATE"

            # Push con retry
            for i in {1..3}; do
              if git push; then
                echo "‚úÖ Push exitoso"
                break
              else
                echo "‚ö†Ô∏è Push fall√≥ (intento $i/3), reintentando..."
                sleep 5
              fi
            done
          fi

      # ========================================
      # 7. NOTIFICACIONES - Resumen
      # ========================================
      - name: üì¢ Resumen de ejecuci√≥n
        if: always()
        run: |
          echo "========================================"
          echo "üìä RESUMEN DE EXTRACCI√ìN"
          echo "========================================"
          echo "Fecha: $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "Repositorio: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""

          if [ -f "data/latest.json" ]; then
            echo "‚úÖ Datos extra√≠dos correctamente"
            echo ""
            echo "üìà M√©tricas:"
            python -c "
          import json
          with open('data/latest.json', 'r') as f:
              data = json.load(f)

          leads = data.get('leads_creados', 0)
          reuniones = data.get('reuniones', {})
          total_agendadas = sum(s.get('agendadas', 0) for s in reuniones.values())
          total_realizadas = sum(s.get('realizadas', 0) for s in reuniones.values())
          show_up = (total_realizadas / total_agendadas * 100) if total_agendadas > 0 else 0

          print(f'  Leads creados: {leads}')
          print(f'  Reuniones agendadas: {total_agendadas}')
          print(f'  Reuniones realizadas: {total_realizadas}')
          print(f'  Show-up rate: {show_up:.1f}%')
          print()
          print('üìä Por setter:')
          for setter, metrics in reuniones.items():
              agendadas = metrics.get('agendadas', 0)
              realizadas = metrics.get('realizadas', 0)
              rate = (realizadas / agendadas * 100) if agendadas > 0 else 0
              print(f'  {setter}: {realizadas}/{agendadas} ({rate:.1f}%)')
          "
          else
            echo "‚ùå No se generaron datos"
          fi

          echo ""
          echo "========================================"

      # ========================================
      # 8. CLEANUP - Limpiar archivos sensibles
      # ========================================
      - name: üßπ Limpiar archivos sensibles
        if: always()
        run: |
          echo "üßπ Limpiando archivos temporales con credenciales..."

          # Eliminar archivos con credenciales (NO commitear)
          rm -f config/config.yaml
          rm -f config/google_credentials.json

          echo "‚úÖ Cleanup completado"

      # ========================================
      # 9. UPLOAD - Artefactos para debugging
      # ========================================
      - name: üì§ Upload logs como artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extraction-logs-${{ github.run_id }}
          path: |
            logs/*.log
            data/latest.json
          retention-days: 30
