name: üìä Extracci√≥n Diaria de Datos - RevOps ARE

on:
  schedule:
    # Ejecuta a las 09:30 AM Chile TODO EL A√ëO
    # Durante horario de verano chileno (Oct-Mar): 12:30 UTC = 09:30 CLT
    # Durante horario de invierno chileno (Abr-Sep): 13:30 UTC = 09:30 CLT
    # GitHub Actions ejecutar√° ambos, pero solo uno coincidir√° con 09:30 AM Chile seg√∫n la estaci√≥n
    - cron: '30 12 * * *'  # Verano (Oct-Mar)
    - cron: '30 13 * * *'  # Invierno (Abr-Sep)

  # Permite ejecuci√≥n manual desde GitHub Actions UI
  workflow_dispatch:
    inputs:
      days_back:
        description: 'D√≠as hacia atr√°s a procesar (default: 1)'
        required: false
        default: '1'

env:
  PYTHON_VERSION: '3.10'
  TIMEZONE: 'America/Santiago'

jobs:
  extract-and-update:
    name: üì• Extraer datos y actualizar dashboard
    runs-on: ubuntu-latest

    steps:
      # ==========================================
      # 1. SETUP - Preparaci√≥n del ambiente
      # ==========================================
      - name: üîê Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîë Setup Google Service Account credentials
        run: |
          mkdir -p config
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT }}' > config/google_credentials.json

      - name: ‚öôÔ∏è Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ==========================================
      # 2. EXTRACT - Extracci√≥n de datos
      # ==========================================
      - name: üìä Ejecutar script de extracci√≥n de Google Sheet
        run: |
          echo "==========================================="
          echo "üì• EXTRAYENDO DATOS DE GOOGLE SHEET"
          echo "==========================================="
          python3 scripts/read_sheet_to_json.py
          echo ""
          echo "‚úÖ Extracci√≥n completada"
          echo ""
          echo "üìÑ Contenido de latest.json:"
          cat data/latest.json

      # ==========================================
      # 3. COMMIT - Actualizar repositorio
      # ==========================================
      - name: üíæ Commit y Push de latest.json
        run: |
          git add data/latest.json

          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è No hay cambios en latest.json"
          else
            git commit -m "ü§ñ Update: latest.json con datos del $(date +'%d/%m/%Y')"
            git push
            echo "‚úÖ Cambios commiteados y pusheados"
          fi

      # ==========================================
      # 4. CLEANUP - Limpiar archivos sensibles
      # ==========================================
      - name: üßπ Limpiar archivos sensibles
        if: always()
        run: |
          echo "üßπ Limpiando archivos temporales con credenciales..."
          rm -f config/google_credentials.json
          echo "‚úÖ Cleanup completado"

      # ==========================================
      # 5. UPLOAD - Artefactos para debugging
      # ==========================================
      - name: üì§ Upload logs como artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extraction-logs-${{ github.run_id }}
          path: |
            logs/*.log
            data/latest.json
          retention-days: 30
