<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ARE - RevOps Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1.5rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 0.5rem 1rem;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: #667eea;
        }

        .btn-apply {
            padding: 0.5rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
            height: fit-content;
        }

        .btn-apply:hover {
            transform: translateY(-2px);
        }

        .btn-reset {
            padding: 0.5rem 1.5rem;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            height: fit-content;
        }

        .btn-reset:hover {
            background: #f8f9fa;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-card .label {
            color: #7f8c8d;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-card .trend {
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .trend.positive {
            color: #27ae60;
        }

        .trend.negative {
            color: #e74c3c;
        }

        .stat-card {
            position: relative;
        }

        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 16px;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 8px;
            vertical-align: middle;
        }

        .tooltip-text {
            visibility: hidden;
            position: absolute;
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            font-size: 0.85rem;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }

        .stat-card:hover .tooltip-text,
        .tooltip-icon:hover + .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .tooltip-text {
                width: 200px;
                font-size: 0.8rem;
                padding: 10px;
            }
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .setter-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .setter-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .setter-card h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .setter-card .badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .setter-card .metric {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .setter-card .metric:last-child {
            border-bottom: none;
        }

        .setter-card .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .setter-card .metric-value {
            font-weight: bold;
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: white;
            font-size: 1.5rem;
        }

        /* NavegaciÃ³n de pestaÃ±as */
        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 1rem 2rem;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Vista SÃ¡bana */
        .sabana-view {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .sabana-view h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .sabana-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
            font-size: 0.85rem;
        }

        .sabana-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sabana-table th {
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .sabana-table tbody tr {
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.2s;
        }

        .sabana-table tbody tr:hover {
            background: #f8f9fa;
        }

        .sabana-table td {
            padding: 0.75rem;
            color: #2c3e50;
            white-space: nowrap;
        }

        .sabana-table td:first-child {
            font-weight: 600;
            color: #667eea;
        }

        .sabana-section-header {
            background: #f8f9fa !important;
            font-weight: 700;
            color: #2c3e50 !important;
        }

        .sabana-section-header td {
            padding: 1rem 0.75rem !important;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .stat-card .value {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                padding: 0.75rem 1rem;
            }

            .tooltip-text {
                width: 200px;
                font-size: 0.8rem;
                padding: 10px;
            }

            .sabana-view {
                padding: 1rem;
            }

            .sabana-table {
                font-size: 0.75rem;
            }

            .sabana-table th,
            .sabana-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading" id="loading">Cargando datos...</div>

        <!-- NavegaciÃ³n de pestaÃ±as -->
        <div class="nav-tabs" id="navTabs" style="display: none;">
            <button class="nav-tab active" onclick="switchView('dashboard')">ðŸ“Š Dashboard</button>
            <button class="nav-tab" onclick="switchView('sabana')">ðŸ“‹ SÃ¡bana</button>
        </div>

        <!-- Vista Dashboard -->
        <div id="dashboard" style="display: none;">
            <div class="header">
                <div>
                    <h1>ðŸ“Š Dashboard ARE - RevOps Analytics</h1>
                    <p class="subtitle" id="lastUpdate">Cargando datos...</p>
                </div>
                <div class="filters">
                    <div class="filter-group">
                        <label for="dateFrom">Fecha Desde</label>
                        <input type="date" id="dateFrom">
                    </div>
                    <div class="filter-group">
                        <label for="dateTo">Fecha Hasta</label>
                        <input type="date" id="dateTo">
                    </div>
                    <div class="filter-group">
                        <label for="quickFilter">PerÃ­odos RÃ¡pidos</label>
                        <select id="quickFilter">
                            <option value="">Personalizado</option>
                            <option value="7">Ãšltimos 7 dÃ­as</option>
                            <option value="15">Ãšltimos 15 dÃ­as</option>
                            <option value="30" selected>Ãšltimos 30 dÃ­as</option>
                            <option value="all">Todo el perÃ­odo</option>
                        </select>
                    </div>
                    <button class="btn-apply" onclick="applyFilters()">Aplicar Filtros</button>
                    <button class="btn-reset" onclick="resetFilters()">Resetear</button>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid"></div>

            <div class="setter-cards" id="setterCards"></div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3 id="leadsTitle">ðŸ“ˆ Leads Creados</h3>
                    <div class="chart-container">
                        <canvas id="leadsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ðŸ“ž Reuniones Agendadas vs Realizadas</h3>
                    <div class="chart-container">
                        <canvas id="meetingsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 id="callsTitle">ðŸ‘¥ Llamadas por Setter</h3>
                    <div class="chart-container">
                        <canvas id="callsChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ðŸŽ¯ DistribuciÃ³n de Reuniones Agendadas</h3>
                    <div class="chart-container">
                        <canvas id="showupChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ðŸ’° InversiÃ³n en CampaÃ±as</h3>
                    <div class="chart-container">
                        <canvas id="inversionChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ðŸ’µ Costo por Lead</h3>
                    <div class="chart-container">
                        <canvas id="costoChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista SÃ¡bana -->
        <div id="sabana" style="display: none;">
            <div class="sabana-view">
                <h2>ðŸ“‹ SÃ¡bana de Datos Completa</h2>
                <div style="overflow-x: auto;">
                    <table class="sabana-table" id="sabanaTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Leads Creados</th>
                                <th>Llamadas Realizadas</th>
                                <th>Reuniones Agendadas</th>
                                <th>Reuniones Realizadas</th>
                                <th>Clientes con Reserva</th>
                                <th>Reservas</th>
                                <th>InversiÃ³n</th>
                                <th>CPL</th>
                            </tr>
                        </thead>
                        <tbody id="sabanaTableBody">
                            <!-- Los datos se cargarÃ¡n dinÃ¡micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let originalData = null;
        let filteredData = null;
        let leadsChart, meetingsChart, callsChart, agendasChart, inversionChart, costoChart;

        // Cargar datos desde GitHub
        async function loadData() {
            try {
                const response = await fetch('./data/latest.json');
                if (!response.ok) throw new Error('Error al cargar datos');
                originalData = await response.json();
                filteredData = JSON.parse(JSON.stringify(originalData));

                document.getElementById('loading').style.display = 'none';
                document.getElementById('navTabs').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'block';

                initializeDateFilters();
                renderDashboard();
                renderSabana();
            } catch (error) {
                document.getElementById('loading').textContent = 'Error al cargar los datos: ' + error.message;
            }
        }

        function initializeDateFilters() {
            const dates = originalData.datos.map(d => d.fecha);
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];

            document.getElementById('dateFrom').value = minDate;
            document.getElementById('dateTo').value = maxDate;
            document.getElementById('dateFrom').min = minDate;
            document.getElementById('dateFrom').max = maxDate;
            document.getElementById('dateTo').min = minDate;
            document.getElementById('dateTo').max = maxDate;
        }

        function applyFilters() {
            const quickFilter = document.getElementById('quickFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            let filtered = originalData.datos;

            if (quickFilter === 'all') {
                filtered = originalData.datos;
            } else if (quickFilter && quickFilter !== '') {
                const days = parseInt(quickFilter);
                filtered = originalData.datos.slice(-days - 1, -1);
            } else {
                filtered = originalData.datos.filter(d => {
                    return d.fecha >= dateFrom && d.fecha <= dateTo;
                });
            }

            filteredData = {
                ...originalData,
                datos: filtered,
                total_dias: filtered.length,
                fecha_ultimo_dato: filtered.length > 0 ? filtered[filtered.length - 1].fecha : originalData.fecha_ultimo_dato
            };

            renderDashboard();
        }

        function resetFilters() {
            document.getElementById('quickFilter').value = '30';
            initializeDateFilters();
            applyFilters();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(value);
        }

        // Cambiar entre vistas
        function switchView(view) {
            // Actualizar botones activos
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Mostrar/ocultar vistas
            if (view === 'dashboard') {
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('sabana').style.display = 'none';
            } else if (view === 'sabana') {
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('sabana').style.display = 'block';
                renderSabana(); // Re-renderizar con datos filtrados
            }
        }

        // Renderizar vista SÃ¡bana
        function renderSabana() {
            const data = filteredData;
            const tbody = document.getElementById('sabanaTableBody');

            // Obtener todos los setters Ãºnicos
            const setters = {};
            data.datos.forEach(dia => {
                if (dia.setters) {
                    Object.keys(dia.setters).forEach(setter => {
                        if (!setters[setter]) {
                            setters[setter] = true;
                        }
                    });
                }
            });

            let html = '';

            // SecciÃ³n: Datos generales
            html += '<tr class="sabana-section-header"><td colspan="9">ðŸ“Š DATOS GENERALES</td></tr>';
            data.datos.forEach(dia => {
                const inversion = dia.inversion || 0;
                const leadsCreados = dia.leads_creados || 0;
                const cpl = (inversion > 0 && leadsCreados > 0) ? (inversion / leadsCreados) : 0;
                html += `
                    <tr>
                        <td>${dia.fecha}</td>
                        <td>${leadsCreados}</td>
                        <td>${dia.llamadas_realizadas || 0}</td>
                        <td>${dia.reuniones_agendadas || 0}</td>
                        <td>${dia.reuniones_realizadas || 0}</td>
                        <td>${dia.clientes_con_reserva || 0}</td>
                        <td>${dia.reservas || 0}</td>
                        <td>${formatCurrency(inversion)}</td>
                        <td>${cpl > 0 ? formatCurrency(cpl) : '$0'}</td>
                    </tr>
                `;
            });

            // SecciÃ³n: Setters
            html += '<tr class="sabana-section-header"><td colspan="9">ðŸ‘¥ SETTERS</td></tr>';
            Object.keys(setters).forEach(setter => {
                html += `<tr class="sabana-section-header"><td colspan="9">${setter}</td></tr>`;

                data.datos.forEach(dia => {
                    if (dia.setters && dia.setters[setter]) {
                        const s = dia.setters[setter];
                        html += `
                            <tr>
                                <td>${dia.fecha}</td>
                                <td colspan="1">${s.llamadas_realizadas || 0} llamadas</td>
                                <td colspan="1">${s.reuniones_agendadas || 0} agendadas</td>
                                <td colspan="6">${s.reuniones_realizadas || 0} realizadas</td>
                            </tr>
                        `;
                    }
                });
            });

            // SecciÃ³n: Leads que entraron hoy
            html += '<tr class="sabana-section-header"><td colspan="9">ðŸ“¥ LEADS QUE ENTRARON HOY</td></tr>';
            data.datos.forEach(dia => {
                html += `
                    <tr>
                        <td>${dia.fecha}</td>
                        <td colspan="8">${dia.leads_creados || 0} leads</td>
                    </tr>
                `;
            });

            // SecciÃ³n: Leads creados
            html += '<tr class="sabana-section-header"><td colspan="9">ðŸ“Š LEADS CREADOS</td></tr>';
            data.datos.forEach(dia => {
                html += `
                    <tr>
                        <td>${dia.fecha}</td>
                        <td colspan="8">${dia.leads_creados || 0} leads</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function renderDashboard() {
            const data = filteredData;

            document.getElementById('lastUpdate').textContent =
                `Ãšltima actualizaciÃ³n: ${data.fecha_actualizacion} | Total dÃ­as: ${data.total_dias} | Datos hasta: ${data.fecha_ultimo_dato}`;

            const totalLeads = data.datos.reduce((sum, d) => sum + d.leads_creados, 0);
            const totalLlamadasRealizadas = data.datos.reduce((sum, d) => sum + d.llamadas_realizadas, 0);
            const totalReunionesAgendadasDia = data.datos.reduce((sum, d) => sum + d.reuniones_agendadas_dia, 0);
            const totalInversion = data.datos.reduce((sum, d) => sum + d.inversion_campanas, 0);
            const costoPromedioLead = totalLeads > 0 ? totalInversion / totalLeads : 0;

            const totalReunionesAgendadas = data.datos.reduce((sum, d) => sum + d.totales.reuniones_agendadas, 0);
            const totalReunionesRealizadas = data.datos.reduce((sum, d) => sum + d.totales.reuniones_realizadas, 0);
            const showUpRate = totalReunionesAgendadas > 0 ? (totalReunionesRealizadas / totalReunionesAgendadas * 100).toFixed(1) : 0;
            const tasaConversionDia = totalLlamadasRealizadas > 0 ? (totalReunionesAgendadasDia / totalLlamadasRealizadas * 100).toFixed(1) : 0;

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="label">Total Leads</div>
                    <div class="value">${totalLeads}</div>
                    <div class="trend positive">â†— ${data.total_dias} dÃ­as</div>
                </div>
                <div class="stat-card">
                    <div class="label">InversiÃ³n Total</div>
                    <div class="value">${formatCurrency(totalInversion)}</div>
                    <div class="trend">PerÃ­odo completo</div>
                </div>
                <div class="stat-card">
                    <div class="label">Costo por Lead Promedio</div>
                    <div class="value">${formatCurrency(costoPromedioLead)}</div>
                    <div class="trend">PerÃ­odo completo</div>
                </div>
                <div class="stat-card">
                    <div class="label">
                        Tasa ConversiÃ³n DÃ­a
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Porcentaje de leads que agendaron reuniÃ³n el mismo dÃ­a que fueron creados.</span>
                    </div>
                    <div class="value">${tasaConversionDia}%</div>
                    <div class="trend ${tasaConversionDia >= 20 ? 'positive' : 'negative'}">${tasaConversionDia >= 20 ? 'âœ“ Objetivo alcanzado' : 'âš  Por debajo del objetivo'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Reuniones Agendadas</div>
                    <div class="value">${totalReunionesAgendadas}</div>
                    <div class="trend">PerÃ­odo completo</div>
                </div>
                <div class="stat-card">
                    <div class="label">Reuniones Realizadas</div>
                    <div class="value">${totalReunionesRealizadas}</div>
                    <div class="trend">PerÃ­odo completo</div>
                </div>
                <div class="stat-card">
                    <div class="label">Tasa de Agendamiento Total</div>
                    <div class="value">${showUpRate}%</div>
                    <div class="trend ${showUpRate >= 60 ? 'positive' : 'negative'}">${showUpRate >= 60 ? 'âœ“ Objetivo alcanzado' : 'âš  Por debajo del objetivo'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">Llamadas Realizadas</div>
                    <div class="value">${totalLlamadasRealizadas}</div>
                    <div class="trend">Del dÃ­a</div>
                </div>
            `;

            const setterTotals = {
                Daniela: { llamadas: 0, agendadas: 0 },
                Teresa: { llamadas: 0, agendadas: 0 },
                Matias: { llamadas: 0, agendadas: 0 },
                Robot: { llamadas: 0, agendadas: 0 }
            };

            data.datos.forEach(dia => {
                Object.keys(setterTotals).forEach(setter => {
                    setterTotals[setter].llamadas += dia.reuniones[setter].llamadas;
                    setterTotals[setter].agendadas += dia.reuniones[setter].agendadas;
                });
            });

            const setterCards = document.getElementById('setterCards');
            const setterColors = {
                'Daniela': '#e74c3c',
                'Teresa': '#3498db',
                'Matias': '#2ecc71',
                'Robot': '#9b59b6'
            };

            setterCards.innerHTML = Object.keys(setterTotals).map(setter => {
                const stats = setterTotals[setter];
                const conversionRate = stats.llamadas > 0 ? (stats.agendadas / stats.llamadas * 100).toFixed(1) : 0;
                return `
                    <div class="setter-card">
                        <h4>
                            <span class="badge" style="background: ${setterColors[setter]}"></span>
                            ${setter}
                        </h4>
                        <div class="metric">
                            <span class="metric-label">Llamadas</span>
                            <span class="metric-value">${stats.llamadas}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Reuniones Agendadas</span>
                            <span class="metric-value">${stats.agendadas}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Tasa de ConversiÃ³n</span>
                            <span class="metric-value">${conversionRate}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            const chartData = data.datos.filter(d => d.leads_creados > 0);
            const last7Days = chartData.slice(-7);

            document.getElementById('leadsTitle').textContent = `ðŸ“ˆ Leads Creados (${data.total_dias} dÃ­as)`;
            document.getElementById('callsTitle').textContent = `ðŸ‘¥ Llamadas por Setter (${Math.min(7, last7Days.length)} dÃ­as)`;

            if (leadsChart) leadsChart.destroy();
            leadsChart = new Chart(document.getElementById('leadsChart'), {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.fecha.slice(5)),
                    datasets: [{
                        label: 'Leads Creados',
                        data: chartData.map(d => d.leads_creados),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            if (meetingsChart) meetingsChart.destroy();
            meetingsChart = new Chart(document.getElementById('meetingsChart'), {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.fecha.slice(5)),
                    datasets: [
                        {
                            label: 'Agendadas',
                            data: chartData.map(d => d.totales.reuniones_agendadas),
                            backgroundColor: 'rgba(52, 152, 219, 0.6)'
                        },
                        {
                            label: 'Realizadas',
                            data: chartData.map(d => d.totales.reuniones_realizadas),
                            backgroundColor: 'rgba(46, 204, 113, 0.6)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            if (callsChart) callsChart.destroy();
            callsChart = new Chart(document.getElementById('callsChart'), {
                type: 'bar',
                data: {
                    labels: last7Days.map(d => d.fecha.slice(5)),
                    datasets: Object.keys(setterColors).map(setter => ({
                        label: setter,
                        data: last7Days.map(d => d.reuniones[setter].llamadas),
                        backgroundColor: setterColors[setter] + '99'
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true }
                    }
                }
            });

            if (agendasChart) agendasChart.destroy();
            agendasChart = new Chart(document.getElementById('showupChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(setterTotals),
                    datasets: [{
                        label: 'Reuniones Agendadas',
                        data: Object.keys(setterTotals).map(setter => setterTotals[setter].agendadas),
                        backgroundColor: Object.values(setterColors)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            if (inversionChart) inversionChart.destroy();
            inversionChart = new Chart(document.getElementById('inversionChart'), {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.fecha.slice(5)),
                    datasets: [{
                        label: 'InversiÃ³n (CLP)',
                        data: chartData.map(d => d.inversion_campanas),
                        backgroundColor: 'rgba(155, 89, 182, 0.6)',
                        borderColor: '#9b59b6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            if (costoChart) costoChart.destroy();
            costoChart = new Chart(document.getElementById('costoChart'), {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.fecha.slice(5)),
                    datasets: [{
                        label: 'Costo por Lead (CLP)',
                        data: chartData.map(d => d.costo_por_lead),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            document.getElementById('quickFilter').addEventListener('change', (e) => {
                if (e.target.value !== '') {
                    applyFilters();
                }
            });
        });
    </script>
</body>
</html>
